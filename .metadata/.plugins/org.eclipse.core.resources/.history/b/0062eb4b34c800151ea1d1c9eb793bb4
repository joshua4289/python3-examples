import numpy as np
import matplotlib.pyplot as plt
import PIL.Image as Image
import skimage.measure as measure
import skimage.morphology as morphology
import scipy.ndimage as nd

def load_image( infilename ) :
    img = Image.open( infilename )
    img.load()
    data = np.asarray( img, dtype="int32" )
    return data

rice = load_image("images/rice.jpg")
print "Shape of raw image: {}".format(rice.shape)
rice = rice[:,:,0]
print "Shape of red image: {}".format(rice.shape)

rice[ rice[:,:] > 120 ] = 256
rice[ rice[:,:] <= 120 ] = 0
rice_filled = nd.binary_fill_holes(rice).astype(int)
rice_filled = morphology.binary_closing(rice_filled)
plt.imshow(rice_filled, interpolation="none", cmap="gray")
plt.show()
rice_labelled = measure.label(rice_filled)

# rice_cleaned = morphology.remove_small_objects(rice_labelled, min_size=160, connectivity=100, in_place=False)
rice_cleaned = morphology.remove_small_objects(rice_labelled)
plt.imshow(rice_cleaned, interpolation="none", cmap="gray")
plt.show()

rice_labelled = measure.label(rice_cleaned)
# print labels
props = measure.regionprops(rice_labelled, ['FilledArea', 'Label'])
print len(props)
